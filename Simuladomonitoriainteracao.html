<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Simulado de Monitoria</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #f4f4f4;
    }

    .quiz-container {
      max-width: 800px;
      width: 100%;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .question {
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .options {
      margin-top: 15px;
    }

    /* Estilos unificados para todas as opções (estáticas e dinâmicas) */
    .option, label.option, label, #newQuestionsContent label {
      display: flex; /* Para alinhar imagem e texto */
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      position: relative; /* Para posicionar a tesoura */
    }

    /* FORÇA a remoção de inputs de radio em QUALQUER lugar */
    .option input[type="radio"], 
    label input[type="radio"],
    #newQuestionsContent input[type="radio"],
    #newQuestionsContent label input[type="radio"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        position: absolute !important;
        left: -9999px !important;
    }

    .option:hover, 
    label.option:hover, 
    label:hover,
    #newQuestionsContent label:hover {
      background-color: #e9e9e9;
    }

    .option.selected, 
    label.option.selected, 
    label.selected,
    #newQuestionsContent label.selected {
      background-color: #d1e7dd;
      border-color: #28a745;
    }

    .option.correct, 
    label.option.correct, 
    label.correct,
    #newQuestionsContent label.correct {
      background-color: #d4edda;
      border-color: #28a745;
    }

    .option.incorrect, 
    label.option.incorrect, 
    label.incorrect,
    #newQuestionsContent label.incorrect {
      background-color: #f8d7da;
      border-color: #dc3545;
    }

    .submit-btn {
      display: block;
      width: 100%;
      padding: 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 30px;
    }

    .submit-btn:hover {
      background-color: #0056b3;
    }

    .results {
      text-align: center;
      margin-top: 30px;
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .scissor-icon {
      margin-right: 10px; /* Espaço entre a tesoura e o texto da opção */
      width: 20px; /* Ajuste conforme o tamanho da sua imagem */
      height: 20px; /* Ajuste conforme o tamanho da sua imagem */
      opacity: 0.5; /* Transparência como no original */
      cursor: pointer;
    }

    .scissor-icon.hidden {
      display: none;
    }

    .struck-through {
      text-decoration: line-through;
      color: #888;
    }

    .comment {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-left: 4px solid #007bff;
      font-style: italic;
      color: #555;
      display: none; /* Escondido por padrão */
    }
    .comment.show {
      display: block; /* Mostrado quando ativado */
    }

    /* Estilos para o botão de navegação de erro / diagnóstico */
    .error-nav-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #dc3545; /* Vermelho para erro */
      color: white;
      border: none;
      border-radius: 50%; /* Torna o botão redondo */
      width: 60px;
      height: 60px;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none; /* Escondido por padrão */
      flex-direction: column; /* Para empilhar o ícone e o contador */
      padding: 5px; /* Ajuste o padding para acomodar texto maior */
      box-sizing: border-box; /* Garante que padding não aumente o tamanho total */
      text-align: center;
    }

    .error-nav-btn:hover {
      background-color: #c82333;
    }

    .error-nav-btn .arrow-icon {
      font-size: 30px; /* Tamanho da seta */
      line-height: 1; /* Ajuste para centralizar */
    }

    .error-nav-btn .button-text {
      font-size: 12px; /* Tamanho do texto abaixo da seta */
      line-height: 1;
      margin-top: 2px; /* Espaço entre a seta e o texto */
    }

    /* Estilos para a seção de diagnóstico de erros */
    .error-diagnosis-section {
        margin-top: 50px;
        padding: 30px;
        background-color: #ffe0b2; /* Um laranja claro ou similar */
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        display: none; /* Escondido por padrão */
        text-align: center;
        font-size: 1.1em;
        color: #333;
    }

    .error-diagnosis-section h2 {
        color: #e65100; /* Laranja mais escuro */
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    .error-diagnosis-section ul {
        list-style: none; /* Remove marcadores de lista */
        padding: 0;
        margin: 0;
    }

    .error-diagnosis-section li {
        background-color: #ff9800; /* Laranja */
        color: white;
        padding: 8px 15px;
        margin: 8px 0;
        border-radius: 5px;
        display: inline-block; /* Para que os itens fiquem lado a lado */
        margin-right: 10px;
        font-weight: bold;
    }
    .error-diagnosis-section li:last-child {
        margin-right: 0;
    }
 .card-bloco {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fff;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <div class="quiz-container">
    <h1 style="text-align:center; margin-bottom: 30px;">Simulado de Monitoria</h1>
    <div class="card-bloco" id="quiz"></div>
    <button class="submit-btn" id="verifyAnswersBtn">Verificar Respostas</button>

    <button class="generate-questions-btn submit-btn" id="generateNewQuestionsBtn" style="display:none;">
      Gerar Novas Perguntas
    </button>

    <div class="results card-bloco" id="results"></div>
    <div id="statusMessage" style="text-align: center; margin-top: 10px; font-weight: bold; color: #007bff;"></div>

    <div class="error-diagnosis-section card-bloco" id="errorDiagnosis">
      <h2>Diagnóstico de Erros</h2>
      <p>Parece que você precisa revisar os seguintes assuntos:</p>
      <ul id="topicsToReview"></ul>
    </div>

    <div class="generated-questions-section card-bloco" id="generatedQuestionsSection" style="display:none;">
      <h2>Novas Perguntas Geradas</h2>
      <div id="newQuestionsContent"></div>
    </div>
  </div>
  
  <button class="error-nav-btn" id="errorNavBtn" style="display:none;">
    <span class="arrow-icon"></span>
    <span class="button-text"></span>
  </button>

  <script>
    const quizContainer = document.getElementById("quiz");
    const resultsContainer = document.getElementById("results");
    const errorNavBtn = document.getElementById("errorNavBtn");
    const arrowIcon = errorNavBtn.querySelector(".arrow-icon");
    const buttonText = errorNavBtn.querySelector(".button-text");
    const errorDiagnosisSection = document.getElementById("errorDiagnosis");
    const topicsToReviewList = document.getElementById("topicsToReview");
    const generateNewQuestionsBtn = document.getElementById("generateNewQuestionsBtn");
    const generatedQuestionsSection = document.getElementById("generatedQuestionsSection");
    const newQuestionsContent = document.getElementById("newQuestionsContent");
    const statusMessage = document.getElementById("statusMessage");

    let wrongQuestionIndices = [];
    let errorCountByTopic = {};
    let totalAnsweredQuestionsByTopic = {};
    let currentWrongQuestionIndex = -1;
    let hasErrors = false;
    let isShowingErrors = false;
    let isShowingDiagnosis = false;

    // Inicializa a visibilidade das seções no carregamento
    errorDiagnosisSection.style.display = 'none';
    topicsToReviewList.innerHTML = '';
    statusMessage.textContent = '';

    const questions = [     {       question: "1. Durante a consulta, um paciente relata que tem sentido “fraqueza e tristeza” sem sintomas específicos. O médico entende que, além da investigação clínica, a relação de confiança construída na consulta é essencial. Isso demonstra que:",       options: [         "a) A consulta é apenas um momento de diagnóstico objetivo.",         "b) A consulta é o núcleo da prática clínica, pois integra aspectos técnicos e humanos.",         "c) O objetivo da consulta é sempre medicar o paciente.",         "d) Queixas inespecíficas não devem ser acolhidas.",       ],       correctAnswer: "b) A consulta é o núcleo da prática clínica, pois integra aspectos técnicos e humanos.",       comment: "A prática clínica moderna vai muito além da simples aplicação de conhecimento técnico. A consulta é o momento central onde o profissional de saúde integra sua expertise científica com habilidades de comunicação, empatia e acolhimento. Para queixas vagas como “fraqueza e tristeza”, a construção de um vínculo de confiança é fundamental para que o paciente se sinta seguro para expressar seus anseios, permitindo uma investigação mais aprofundada e um cuidado verdadeiramente centrado na pessoa.",       topic: "Relação Médico-Paciente e Núcleo da Prática Clínica",     },     {       question: "2. Um paciente chega apenas para renovar receita de hipertensão, sem apresentar novos sintomas. Nesse caso, sua principal motivação corresponde a:",       options: [         "a) Uma queixa.",         "b) Uma demanda objetiva.",         "c) Uma conduta médica.",         "d) Uma manifestação subjetiva de sofrimento.",       ],       correctAnswer: "b) Uma demanda objetiva.",       comment: "É importante diferenciar 'queixa' de 'demanda'. A queixa é a manifestação de um sofrimento ou incômodo (ex: dor de cabeça, tosse). A demanda é a expectativa ou o pedido concreto que o paciente traz para a consulta. Neste caso, o paciente não relata um sofrimento (queixa), mas apresenta um pedido claro e específico: a renovação da receita. Trata-se, portanto, de uma demanda objetiva.",       topic: "Diferença entre Queixa e Demanda na Consulta Médica",     },     {       question: "3. Durante uma manhã de atendimentos na Unidade Básica de Saúde, um médico de família recebe Dona Maria, 58 anos, que relata estar “se sentindo para baixo”... Com base nesse cenário, pode-se afirmar que:",       options: [         "a) A consulta médica é o núcleo da prática clínica porque vai além do diagnóstico, sendo um espaço de encontro, escuta e construção de confiança.",         "b) A consulta deve sempre resultar em prescrição de medicamento, pois esse é o principal objetivo.",         "c) Queixas como a de Dona Maria não fazem parte do papel do médico de família, devendo ser descartadas.",         "d) O núcleo da prática clínica está nos exames complementares, que devem ser priorizados frente a qualquer relato subjetivo.",       ],       correctAnswer: "a) A consulta médica é o núcleo da prática clínica porque vai além do diagnóstico, sendo um espaço de encontro, escuta e construção de confiança.",       comment: "Este cenário ilustra perfeitamente o conceito da questão 1. O valor da consulta não está apenas em identificar uma doença orgânica, mas em ser um espaço terapêutico de escuta e validação do sofrimento do paciente. Acolher queixas subjetivas e construir uma relação de confiança são competências essenciais do médico de família.",       topic: "A Consulta na Atenção Primária à Saúde",     },     {       question: "4. A decisão compartilhada se caracteriza por:",       options: [         "a) O médico tomar todas as decisões sozinho.",         "b) O paciente decidir sem participação do médico.",         "c) Médico e paciente decidirem juntos, unindo evidências e preferências.",         "d) Uso exclusivo de protocolos científicos sem considerar o paciente.",       ],       correctAnswer: "c) Médico e paciente decidirem juntos, unindo evidências e preferências.",       comment: "A tomada de decisão compartilhada é um pilar da atenção centrada na pessoa. Nesse modelo, o médico apresenta as melhores evidências científicas disponíveis, os riscos e benefícios das opções de tratamento, enquanto o paciente expressa seus valores, medos, expectativas e preferências. A decisão final é uma construção conjunta que respeita tanto o conhecimento técnico quanto a autonomia do paciente.",       topic: "Tomada de Decisão Compartilhada",     },     {       question: "5. Uma paciente hipertensa recusa aumento da dose por medo de efeitos colaterais. O médico deve:",       options: [         "a) Impor o aumento, pois o protocolo manda.",         "b) Explicar riscos e benefícios, ouvindo preferências da paciente.",         "c) Encerrar a consulta sem discutir.",         "d) Negar atendimento até ela aceitar.",       ],       correctAnswer: "b) Explicar riscos e benefícios, ouvindo preferências da paciente.",       comment: "Esta é uma aplicação prática da decisão compartilhada. A postura correta não é impor uma conduta, mas dialogar. O médico deve informar a paciente sobre a importância do ajuste da dose (benefícios) e os possíveis efeitos adversos (riscos), acolhendo seus medos e buscando, em conjunto, a melhor alternativa que ela se sinta confortável em seguir.",       topic: "Aplicação da Decisão Compartilhada em Casos Clínicos",     },     {       question: "6. Uma paciente de 45 anos, diabética tipo 2... Qual deve ser a postura adequada do médico, considerando os princípios da decisão compartilhada?",       options: [         "a) Respeitar a autonomia da paciente, discutir riscos e benefícios e buscar uma conduta que considere suas preferências.",         "b) Prescrever insulina, pois o protocolo deve ser seguido.",         "c) Encerrar a consulta, deixando a paciente sem tratamento até aceitar.",         "d) Negar o tratamento até que a paciente concorde com a proposta inicial.",       ],       correctAnswer: "a) Respeitar a autonomia da paciente, discutir riscos e benefícios e buscar uma conduta que considere suas preferências.",       comment: "Novamente, o princípio da decisão compartilhada é central. A recusa da paciente não deve ser vista como um obstáculo, mas como um ponto de partida para a negociação. O papel do médico é explorar os medos da paciente ('medo de agulhas', 'receio de depender'), informar adequadamente e, juntos, elaborar um plano terapêutico que seja clinicamente adequado e, ao mesmo tempo, aceitável para ela.",       topic: "Autonomia do Paciente e Adesão ao Tratamento",     },     {       question: "7. Uma paciente com diabetes recusa iniciar insulina, alegando medo de agulhas e de perder autonomia. O médico deve:",       options: [         "a) Discutir riscos/benefícios e decidir junto a melhor conduta.",         "b) Insistir na insulina, pois o protocolo não pode ser questionado.",         "c) Encerrar a consulta sem intervir.",         "d) Prescrever insulina contra a vontade da paciente.",       ],       correctAnswer: "a) Discutir riscos/benefícios e decidir junto a melhor conduta.",       comment: "Esta questão reforça o mesmo conceito das anteriores. A melhor abordagem é sempre o diálogo, a negociação e o respeito à autonomia do paciente, buscando uma solução conjunta. Impor um tratamento ou abandonar o paciente são atitudes que quebram a relação de confiança e prejudicam a adesão.",       topic: "Manejo de Recusa Terapêutica",     },     {       question: "8. A frase “Nenhuma decisão a meu respeito sem a minha participação” resume qual princípio da atenção primária?",       options: [         "a) Medicina baseada apenas em evidências.",         "b) Tomada de decisão compartilhada.",         "c) Relação clínica centrada no médico.",         "d) Consulta restrita ao diagnóstico.",       ],       correctAnswer: "b) Tomada de decisão compartilhada.",       comment: "Essa frase é um lema que sintetiza a essência da tomada de decisão compartilhada e do princípio da autonomia do paciente. Ela representa a mudança de um modelo paternalista (centrado no médico) para um modelo colaborativo, onde o paciente é protagonista do seu próprio cuidado.",       topic: "Princípios da Atenção Primária à Saúde",     },     {       question: "9. A diferença entre demanda e queixa é que:",       options: [         "a) A demanda é subjetiva e a queixa é objetiva.",         "b) A demanda é expectativa de solução, a queixa é manifestação de incômodo.",         "c) A queixa é sempre resolvida, a demanda nunca.",         "d) Ambas são sinônimos.",       ],       correctAnswer: "b) A demanda é expectativa de solução, a queixa é manifestação de incômodo.",       comment: "A queixa é como o paciente expressa seu mal-estar ou sofrimento (ex: 'estou com dor'). A demanda é o que o paciente espera ou solicita como solução para esse mal-estar (ex: 'quero um remédio', 'preciso de um atestado'). Compreender essa diferença é crucial para manejar a consulta de forma eficaz.",       topic: "Semiologia: Queixa e Demanda",     },     {       question: "10. Paciente diz: “Tenho dor nas costas (queixa) e quero encaminhamento para ortopedista (demanda).” O médico deve:",       options: [         "a) Ignorar a queixa e atender só a demanda.",         "b) Atender a demanda sem avaliar a dor.",         "c) Acolher a queixa, investigar e analisar se a demanda é pertinente.",         "d) Recusar ambos, pois não há conduta possível.",       ],       correctAnswer: "c) Acolher a queixa, investigar e analisar se a demanda é pertinente.",       comment: "A conduta correta é sempre acolher e investigar a queixa (a dor nas costas) por meio da anamnese e do exame físico. Só após essa avaliação clínica o médico terá condições de julgar se a demanda do paciente (o encaminhamento) é a medida mais adequada para o caso ou se outras abordagens seriam mais benéficas.",       topic: "Manejo da Consulta: Acolhimento e Investigação Clínica",     },     {       question: "11. Paciente relata: “Tenho dores no corpo (queixa) e preciso de um laudo para afastamento do trabalho (demanda).” O médico deve compreender que:",       options: [         "a) Queixa e demanda são sinônimos.",         "b) A queixa é o relato subjetivo; a demanda é o pedido objetivo.",         "c) A demanda é sempre insolúvel.",         "d) Apenas a queixa deve ser considerada.",       ],       correctAnswer: "b) A queixa é o relato subjetivo; a demanda é o pedido objetivo.",       comment: "Este exemplo reforça a distinção conceitual. As 'dores no corpo' são a expressão subjetiva do sofrimento do paciente (queixa). O 'laudo para afastamento' é o pedido concreto e objetivo que ele traz (demanda).",       topic: "Análise de Queixa e Demanda",     },     {       question: "12. Durante a consulta, uma mãe traz seu filho com febre (queixa) e pede um atestado escolar (demanda). A postura correta do médico é:",       options: [         "a) Avaliar a febre e fornecer atestado se adequado.",         "b) Atender apenas a demanda administrativa.",         "c) Atender apenas a febre e recusar qualquer demanda.",         "d) Ignorar ambos, pois não há gravidade.",       ],       correctAnswer: "a) Avaliar a febre e fornecer atestado se adequado.",       comment: "O profissional deve priorizar o aspecto clínico. Primeiro, avalia-se a criança com febre (queixa) para diagnosticar a causa e orientar o tratamento. Com base nessa avaliação, se for constatada a necessidade de repouso, o médico atende à demanda administrativa (o atestado), que se torna uma consequência justificada do quadro clínico.",       topic: "Integração do Cuidado Clínico e Administrativo",     },     {       question: "13. Segundo a OMS, a assistência domiciliar é:",       options: [         "a) Apenas visita para pacientes terminais.",         "b) Conjunto de serviços de saúde em domicílio para prevenção, tratamento, reabilitação e cuidados paliativos.",         "c) Exclusivamente responsabilidade da família.",         "d) Sempre substituta da consulta em unidade de saúde.",       ],       correctAnswer: "b) Conjunto de serviços de saúde em domicílio para prevenção, tratamento, reabilitação e cuidados paliativos.",       comment: "A assistência domiciliar é uma modalidade de atenção à saúde muito mais ampla do que apenas o cuidado a pacientes terminais. Ela engloba um leque de ações (promoção, prevenção, tratamento, reabilitação, paliativos) oferecidas no conforto do lar do paciente, visando aumentar sua autonomia e integrá-lo ao seu ambiente familiar e social.",       topic: "Conceito de Assistência Domiciliar (Home Care)",     },     {       question: "14. Exemplo de indicação para assistência domiciliar é:",       options: [         "a) Jovem saudável que precisa de atestado escolar.",         "b) Idoso acamado com dificuldade de locomoção.",         "c) Criança que quer renovar receita de vitaminas.",         "d) Consulta preventiva de rotina.",       ],       correctAnswer: "b) Idoso acamado com dificuldade de locomoção.",       comment: "A principal indicação para a assistência domiciliar são pacientes que possuem alguma restrição (permanente ou temporária) que dificulte ou impossibilite sua ida a uma unidade de saúde. Um idoso acamado é o exemplo clássico, pois o cuidado em casa previne complicações do transporte e o mantém em seu ambiente familiar.",       topic: "Indicações para Assistência Domiciliar",     },     {       question: "15. Fatores socioculturais que afetam a saúde familiar incluem:",       options: [         "a) Apenas doenças infecciosas.",         "b) Pobreza, desemprego, violência e arranjos familiares.",         "c) Apenas fatores biológicos.",         "d) Apenas acesso a exames.",       ],       correctAnswer: "b) Pobreza, desemprego, violência e arranjos familiares.",       comment: "A saúde não é determinada apenas por fatores biológicos. Os Determinantes Sociais da Saúde (DSS) mostram que as condições em que as pessoas nascem, vivem, trabalham e envelhecem têm um impacto profundo no seu bem-estar. Fatores como renda, escolaridade, saneamento, segurança e a estrutura familiar são cruciais para a saúde de uma família.",       topic: "Determinantes Sociais da Saúde e Saúde Familiar",     },     {       question: "16. Uma família em situação de violência doméstica pode ter:",       options: [         "a) Nenhum impacto na saúde.",         "b) Adoecimento físico, emocional e social dos membros.",         "c) Apenas problemas escolares.",         "d) Apenas aumento de consultas administrativas.",       ],       correctAnswer: "b) Adoecimento físico, emocional e social dos membros.",       comment: "A violência é um grave problema de saúde pública com consequências devastadoras. Ela não causa apenas lesões físicas, mas também adoecimento mental (ansiedade, depressão, estresse pós-traumático), isolamento social e desestruturação dos vínculos familiares, afetando a saúde de todos os membros da família em múltiplas dimensões.",       topic: "Impacto da Violência na Saúde Familiar",     },     {       question: "17. As quatro dimensões da experiência da doença são:",       options: [         "a) Sentimentos, ideias, efeito no funcionamento, expectativas.",         "b) Diagnóstico, exames, medicamentos, alta hospitalar.",         "c) Queixa, demanda, conduta, prognóstico.",         "d) Protocolos, evidências, adesão, mortalidade.",       ],       correctAnswer: "a) Sentimentos, ideias, efeito no funcionamento, expectativas.",       comment: "Esta alternativa descreve o modelo FIFE (do inglês: Feelings, Ideas, Functioning, Expectations). É uma ferramenta mnemônica utilizada para explorar a perspectiva do paciente sobre sua doença:\n•  Sentimentos: Como o paciente se sente em relação à doença (medo, tristeza, preocupação)?\n•  Ideias: O que ele acha que está causando o problema?\n•  Funcionamento: Como a doença está afetando sua vida e suas atividades?\n•  Expectativas: O que ele espera da consulta ou do tratamento?",       topic: "Método Clínico Centrado na Pessoa (Modelo FIFE)",     },     {       question: "18. Paciente diz: “Tenho medo de morrer dessa dor no peito.” O médico deve:",       options: [         "a) Ignorar o medo e apenas pedir exames.",         "b) Acolher o sentimento e integrá-lo à avaliação clínica.",         "c) Desconsiderar a fala do paciente.",         "d) Transferir imediatamente sem escuta.",       ],       correctAnswer: "b) Acolher o sentimento e integrá-lo à avaliação clínica.",       comment: "Esta questão é uma aplicação direta da dimensão 'Sentimentos' do modelo FIFE. A fala do paciente revela um medo intenso (sentimento) que é tão importante quanto o sintoma físico (a dor). Acolher esse sentimento, validando a preocupação do paciente, fortalece a relação médico-paciente e permite uma abordagem mais completa, que cuida tanto do aspecto orgânico quanto do emocional.",       topic: "Abordagem Psicossocial na Consulta",     }, ];

    function buildQuiz() {
      const output = [];

      questions.forEach((currentQuestion, questionNumber) => {
        const options = [];
        for (let i = 0; i < currentQuestion.options.length; i++) {
          options.push(
            `<label class="option" data-question="${questionNumber}" data-value="${currentQuestion.options[i]}">
              <img src="tesouras.png" class="scissor-icon" onclick="event.stopPropagation(); this.parentNode.classList.toggle('struck-through');">
              ${currentQuestion.options[i]}
            </label>`
          );
        }

        output.push(
          `<div class="card" id="question-${questionNumber}" data-topic="${currentQuestion.topic}">
            <div class="question">${currentQuestion.question}</div>
            <div class="options">${options.join("")}</div>
            <div class="comment" id="comment-${questionNumber}"></div>
          </div>`
        );
      });

      quizContainer.innerHTML = output.join("");
    }

    function showResults() {
      wrongQuestionIndices = [];
      errorCountByTopic = {};
      totalAnsweredQuestionsByTopic = {};
      currentWrongQuestionIndex = -1;
      hasErrors = false;
      isShowingErrors = false;
      isShowingDiagnosis = false;

      errorDiagnosisSection.style.display = 'none';
      topicsToReviewList.innerHTML = '';
      statusMessage.textContent = '';

      // Busca por todas as perguntas: estáticas e dinâmicas
      const allQuestionCards = document.querySelectorAll('.quiz-container .card, #newQuestionsContent .card');
      let correctAnswersCount = 0;
      let totalQuestionsAnswered = 0;

      console.log('🔍 Verificando', allQuestionCards.length, 'perguntas...');

      allQuestionCards.forEach((card, index) => {
        const questionEl = card.querySelector('.question') || card.querySelector('p');
        if (!questionEl) return;

        const questionText = questionEl.textContent.trim();
        const optionsContainer = card.querySelector('.options') || card;
        const allOptions = optionsContainer.querySelectorAll('.option, label.option, label');
        const userAnswerElement = optionsContainer.querySelector('.option.selected, label.selected');
        const commentDiv = card.querySelector('.comment');

        const questionTopic = card.dataset.topic || "Tópico não informado";
        
        console.log(`📝 Pergunta ${index + 1}: Tópico = "${questionTopic}"`);
        console.log(`🔍 Encontradas ${allOptions.length} alternativas`);
        
        // Remove classes anteriores
        allOptions.forEach(option => {
          option.classList.remove('correct', 'incorrect', 'selected');
        });
        if (commentDiv) commentDiv.classList.remove('show');

        let correctAnswerValue = null;
        let questionComment = null;

        // Verifica se é pergunta estática ou dinâmica
        const isStatic = card.id && card.id.startsWith('question-');
        if (isStatic) {
          // Pergunta estática - busca nos dados originais
          const questionData = questions.find(q => q.question.trim() === questionText);
          if (questionData) {
            correctAnswerValue = questionData.correctAnswer.trim();
            questionComment = questionData.comment;
          }
        } else {
          // Pergunta dinâmica - busca pela opção marcada como correta
          const correctOpt = optionsContainer.querySelector('.option[data-answer="true"], label[data-answer="true"]');
          if (correctOpt) {
            correctAnswerValue = correctOpt.dataset.value?.trim() || correctOpt.textContent.trim();
            console.log(`✅ Resposta correta encontrada: "${correctAnswerValue}"`);
          } else {
            console.log('❌ Nenhuma resposta correta encontrada para pergunta dinâmica');
          }
          
          // Busca comentário no próprio card ou no div comment
          const commentElement = card.querySelector('.comment');
          if (commentElement && commentElement.textContent.trim()) {
            questionComment = commentElement.textContent.trim();
          }
        }

        // Processa resposta do usuário e aplica coloração
        let userAnswer = null;
        if (userAnswerElement) {
          userAnswerElement.classList.add('selected');
          userAnswer = userAnswerElement.dataset.value?.trim() || userAnswerElement.textContent.trim();
          totalQuestionsAnswered++;
          totalAnsweredQuestionsByTopic[questionTopic] = (totalAnsweredQuestionsByTopic[questionTopic] || 0) + 1;

          console.log(`👤 Resposta do usuário: "${userAnswer}"`);
          console.log(`🎯 Resposta correta: "${correctAnswerValue}"`);

          // Verifica se a resposta está correta
          if (userAnswer === correctAnswerValue) {
            correctAnswersCount++;
            console.log(`✅ Resposta correta!`);
          } else {
            hasErrors = true;
            errorCountByTopic[questionTopic] = (errorCountByTopic[questionTopic] || 0) + 1;
            console.log(`❌ Resposta incorreta para tópico: ${questionTopic}`);
          }
        }

        // Aplica coloração: SEMPRE marca a correta de verde, e a errada de vermelho se foi marcada
        allOptions.forEach(option => {
          const optionValue = option.dataset.value?.trim() || option.textContent.trim();
          
          // Marca a resposta correta de verde SEMPRE
          if (optionValue === correctAnswerValue) {
            option.classList.add('correct');
            console.log(`🟢 Marcando como correta: "${optionValue}"`);
          }
          
          // Se o usuário marcou uma resposta E ela está errada, marca de vermelho
          if (userAnswer && optionValue === userAnswer && userAnswer !== correctAnswerValue) {
            option.classList.add('incorrect');
            console.log(`🔴 Marcando como incorreta: "${optionValue}"`);
          }
        });

        // Mostra comentário se disponível
        if (commentDiv && questionComment) {
          commentDiv.textContent = questionComment;
          commentDiv.classList.add('show');
        }
      });

      // Exibe resultados
      resultsContainer.textContent = `Você acertou ${correctAnswersCount} de ${totalQuestionsAnswered} questões respondidas.`;

      console.log('📊 Erros por tópico:', errorCountByTopic);
      console.log('📊 Total por tópico:', totalAnsweredQuestionsByTopic);

      // Gera diagnóstico de erros
      if (hasErrors) {
        for (const topic in errorCountByTopic) {
          const errors = errorCountByTopic[topic];
          const total = totalAnsweredQuestionsByTopic[topic] || 0;
          if (total > 0) {
            const percent = ((errors / total) * 100).toFixed(1);
            const li = document.createElement('li');
            li.textContent = `${topic}: ${percent}% de erros (${errors} de ${total} questões respondidas)`;
            topicsToReviewList.appendChild(li);
          }
        }
      } else {
        const li = document.createElement('li');
        li.textContent = "🥳 Parabéns! Você não teve erros nas questões respondidas.";
        topicsToReviewList.appendChild(li);
      }

      errorDiagnosisSection.style.display = 'block';
      generatedQuestionsSection.style.display = 'block';
      generateNewQuestionsBtn.style.display = 'block';
      scrollToDiagnosis();
    }

    function scrollToQuestion(index) {
      const questionCard = document.getElementById(`question-${index}`);
      if (questionCard) {
        questionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function scrollToDiagnosis() {
        errorDiagnosisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function scrollToGeneratedQuestions() {
        generatedQuestionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Event listener para seleção de opções (funciona para estáticas e dinâmicas)
    document.addEventListener("click", function (event) {
      const clickedElement = event.target;
      const optionElement = clickedElement.closest('.option');

      if (optionElement) {
          if (clickedElement.classList.contains("scissor-icon")) {
              event.stopPropagation();
              optionElement.classList.toggle("struck-through");
          }
          else {
              const parentCard = optionElement.closest('.card');
              const currentQuestionOptions = parentCard.querySelectorAll('.option');

              currentQuestionOptions.forEach(opt => opt.classList.remove("selected"));
              optionElement.classList.add("selected");
          }
      }
    });

    generateNewQuestionsBtn.addEventListener("click", async function() {
        statusMessage.textContent = '⏳ Gerando novas perguntas...';
        generateNewQuestionsBtn.disabled = true;

        const topics = Object.keys(errorCountByTopic).filter(topic => {
            const errorsInTopic = errorCountByTopic[topic] || 0;
            const totalAnsweredInTopic = totalAnsweredQuestionsByTopic[topic] || 0;
            return errorsInTopic > 0 && totalAnsweredInTopic > 0;
        });

        const topicsToSend = topics.length > 0 ? topics : ["fisiologia celular", "biologia"];

        try {
            const response = await fetch('https://www.quizia.xyz/quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topicos: topicsToSend }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            newQuestionsContent.innerHTML = '';
            if (data && data.html) {
                console.log('📥 HTML recebido do Flask:', data.html);
                
                // Insere o HTML diretamente sem reconstrução complexa
                newQuestionsContent.innerHTML = data.html.replace(/```html|```/g, '');
                
                // Adiciona tesouras e ajusta formatação apenas se necessário
                newQuestionsContent.querySelectorAll('.card').forEach((card, cardIndex) => {
                    // Garante que o elemento de pergunta tenha a classe correta
                    const questionElement = card.querySelector('p');
                    if (questionElement && !questionElement.classList.contains('question')) {
                       questionElement.classList.add('question');
                    }

                    // Remove qualquer input de radio que possa existir e adiciona tesouras
                    card.querySelectorAll('label').forEach((label) => {
                        // Remove inputs de radio MAS preserva o atributo data-answer
                        const radioInput = label.querySelector('input[type="radio"]');
                        if (radioInput) {
                            // PRESERVA o atributo data-answer do input no label
                            if (radioInput.hasAttribute('data-answer')) {
                                label.setAttribute('data-answer', radioInput.getAttribute('data-answer'));
                            }
                            radioInput.remove();
                        }
                        
                        // Garante que tenha a classe option
                        if (!label.classList.contains('option')) {
                            label.classList.add('option');
                        }

                        // Garante que tenha data-value
                        if (!label.dataset.value) {
                            label.dataset.value = label.textContent.trim();
                        }

                        // Adiciona tesoura se não existir
                        if (!label.querySelector('.scissor-icon')) {
                            const scissorIcon = document.createElement('img');
                            scissorIcon.src = 'tesouras.png';
                            scissorIcon.className = 'scissor-icon';
                            scissorIcon.onclick = function(e) {
                                e.stopPropagation();
                                label.classList.toggle('struck-through');
                            };
                            label.insertBefore(scissorIcon, label.firstChild);
                        }
                    });

                    console.log(`🏷️ Card ${cardIndex}: data-topic = "${card.dataset.topic}"`);
                    
                    // Verifica se há opção correta marcada
                    const correctOption = card.querySelector('label[data-answer="true"]');
                    if (correctOption) {
                        console.log(`✅ Opção correta encontrada: "${correctOption.dataset.value}"`);
                    } else {
                        console.log('❌ Nenhuma opção correta encontrada');
                    }
                });
            } else {
                newQuestionsContent.innerHTML = "<p>Não foi possível gerar novas perguntas para os tópicos selecionados.</p>";
            }
            
            generatedQuestionsSection.style.display = 'block';
            scrollToGeneratedQuestions();
            statusMessage.textContent = '✅ Perguntas geradas com sucesso!';
            setTimeout(() => { statusMessage.textContent = '' }, 3000);

        } catch (error) {
            console.error('Erro ao gerar novas perguntas:', error);
            newQuestionsContent.innerHTML = `<p>Erro ao carregar novas perguntas: ${error.message}. Por favor, tente novamente.</p>`;
            generatedQuestionsSection.style.display = 'block';
            scrollToGeneratedQuestions();
            statusMessage.textContent = '❌ Erro na requisição: ' + error.message;
            setTimeout(() => { statusMessage.textContent = '' }, 5000);
        } finally {
            generateNewQuestionsBtn.disabled = false;
        }
    });

    // Inicialização
    buildQuiz();
    errorDiagnosisSection.style.display = 'none';
    generatedQuestionsSection.style.display = 'none';
    generateNewQuestionsBtn.style.display = 'none';

    // Event listener para o botão de verificar respostas
    document.getElementById("verifyAnswersBtn").addEventListener("click", showResults);
  </script>
</body>
</html>
